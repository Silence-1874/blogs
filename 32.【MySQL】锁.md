锁是计算机协调多个进程或线程并发访问某一资源的机制。

### 全局锁
对整个数据库实例加锁，使数据库处于只读状态，主要用于做全库逻辑备份。

- 加锁：`flush tables with read lock`

- 解锁：`unlock tables`

### 表级锁
对整个表加锁，粒度大，锁冲突概率搞，并发度低。

- 加锁: `lock tables table_name read/write`

- 解锁：`unlock tables table_name`

#### 表锁
- 读锁（Read Lock），又称共享锁（Shared Lock，S锁）。针对同一份数据，多个事务的**读操作**可以**同时进行**，互不影响。

- 写锁（Write Lock），又称排他锁（Exclusive Lock，X锁）。针对同一份数据，**只有一个事务**能**写**入，并阻止其他事务的**读写**。

表锁不仅会限制其他线程的访问，也会**限制本线程**的访问。

对

#### 元数据锁
元数据锁（Meta Data Lock，MDL），由系统控制，**无需显式调用，事务提交后自动释放**。

**用于避免DML与DDL冲突，保证读写正确性。**

- 对一个表做**增删改查**操作时，加MDL**读**锁

- 对一个表做**结构更变**操作时，加MDL**写**锁

#### 意向锁
意向锁（Intension Lock），分为**意向共享锁**（IS锁）与**意向排他锁**（IX锁），用于快速判断表里是否有记录被加锁。

在对表中某些记录加上S锁/X锁前，先对表加上IS锁/IX锁。

后续需要加**表锁X锁**前，先判断是否有**IX锁**，若有就可以直接加锁，不需要再去遍历表中每一条记录判断是否有行级锁。

- IS锁：与**表锁S锁**兼容，与**表锁X锁**互斥

- IX锁：与**表锁S锁**和**表锁X锁**都互斥

**意向锁与行级锁**之间不会互斥，**意向锁之间**也不会互斥，在保证并发性的前提下，实现了**行级锁和表级锁共存**且**满足事务隔离性**的要求。

### 行级锁
对行数据加锁，粒度小，锁冲突概率低，并发度高。

InnoDB的数据是基于索引组织的，其行锁也是对**索引项**加锁。

行级锁在**事务提交后**才**释放**。

#### 记录锁
记录锁（Record Lock），锁定**单个行记录**的锁，防止其他事务对这一行进行update或delete。

#### 间隙锁
间隙锁（Gap Lock），锁定索引记录的**间隙**，防止其他事务在间隙中insert。

间隙锁是**相互兼容**的。

#### 临键锁
临键锁（Next-Key Lock），记录锁与间隙锁的组合，**左开右闭**区间，是加锁的**基本单位**。

***通过MVCC与Next-Key Lock，MySQL在可重复读的隔离级别上已经解决了幻读。***

#### 加锁机制
临键锁在一定条件下会退化成记录锁或间隙锁。

##### 唯一索引等值查询
- 查询的记录**存在**，临键锁退化成**记录锁**

- 查询的记录**不存在**，临键锁退化成**间隙锁**

##### 唯一索引范围查询
先加临键锁，再根据范围条件退化成记录锁或间隙锁。

##### 非唯一索引等值查询
- 查询的记录**存在**，往前加**临键锁**，往后加**间隙锁**，共**2把**锁

- 查询的记录**不存在**，加上**临键锁**，随后退化成**间隙锁**，共**1把**锁

##### 非唯一索引范围查询
加临键锁，之后**不会退化**成记录锁或间隙锁。

##### 无索引
全表扫描，**对所有记录加临键锁**，相当于锁住了整个表（但不等于加表锁）。

### 页级锁
对页数据加锁，粒度介于表级锁和行级锁之间，并发度页介于表级锁和行级锁之间。

### 乐观锁&悲观锁
#### 乐观锁
认为并发问题是**小概率**事件，仅在更新时判断数据是否被修改，不采用数据库自身的锁机制，而是通过程序来实现，如**版本号机制**与**CAS机制**。

适合**读操作多**的场景，不会存在死锁。

#### 悲观锁
认为总是会发生并发问题，每次操作前都会上锁。

适合**写操作多**的场景，可能会发生死锁。

以上介绍的几种锁都是悲观锁。

### 显式锁&隐式锁
#### 显式锁
通过特定的语句加锁：

- 加共享锁：`select ... lock in share mode`

- 加排他锁：`select ... for update`

#### 隐式锁
如果检测到不会发生冲突，就不加锁。

在特殊情况下，隐式锁会转换为显式锁。

### 死锁
两个事务为争夺资源而相互等待的现象。

为避免死锁，可以设置事务等待锁的**超时时间**或者开启**死锁检测**。